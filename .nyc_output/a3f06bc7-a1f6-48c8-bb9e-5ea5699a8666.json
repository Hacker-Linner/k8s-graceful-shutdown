{"/Users/sba/Documents/finapiRelated/k8s-graceful-shutdown/lib/k8s-graceful-shutdown.ts":{"path":"/Users/sba/Documents/finapiRelated/k8s-graceful-shutdown/lib/k8s-graceful-shutdown.ts","statementMap":{"0":{"start":{"line":2,"column":0},"end":{"line":2,"column":62}},"1":{"start":{"line":3,"column":18},"end":{"line":3,"column":46}},"2":{"start":{"line":3,"column":32},"end":{"line":3,"column":44}},"3":{"start":{"line":4,"column":12},"end":{"line":4,"column":21}},"4":{"start":{"line":5,"column":14},"end":{"line":5,"column":46}},"5":{"start":{"line":10,"column":30},"end":{"line":20,"column":1}},"6":{"start":{"line":11,"column":31},"end":{"line":15,"column":5}},"7":{"start":{"line":12,"column":8},"end":{"line":14,"column":29}},"8":{"start":{"line":13,"column":12},"end":{"line":13,"column":33}},"9":{"start":{"line":16,"column":4},"end":{"line":16,"column":56}},"10":{"start":{"line":17,"column":4},"end":{"line":19,"column":7}},"11":{"start":{"line":18,"column":8},"end":{"line":18,"column":49}},"12":{"start":{"line":21,"column":0},"end":{"line":21,"column":58}},"13":{"start":{"line":25,"column":33},"end":{"line":33,"column":1}},"14":{"start":{"line":26,"column":30},"end":{"line":26,"column":59}},"15":{"start":{"line":27,"column":4},"end":{"line":28,"column":15}},"16":{"start":{"line":28,"column":8},"end":{"line":28,"column":15}},"17":{"start":{"line":29,"column":4},"end":{"line":29,"column":37}},"18":{"start":{"line":30,"column":4},"end":{"line":32,"column":7}},"19":{"start":{"line":31,"column":8},"end":{"line":31,"column":60}},"20":{"start":{"line":34,"column":0},"end":{"line":34,"column":64}},"21":{"start":{"line":42,"column":24},"end":{"line":63,"column":1}},"22":{"start":{"line":43,"column":4},"end":{"line":47,"column":7}},"23":{"start":{"line":44,"column":8},"end":{"line":46,"column":11}},"24":{"start":{"line":45,"column":12},"end":{"line":45,"column":57}},"25":{"start":{"line":45,"column":41},"end":{"line":45,"column":54}},"26":{"start":{"line":48,"column":4},"end":{"line":62,"column":6}},"27":{"start":{"line":50,"column":8},"end":{"line":50,"column":88}},"28":{"start":{"line":51,"column":8},"end":{"line":61,"column":9}},"29":{"start":{"line":52,"column":12},"end":{"line":57,"column":13}},"30":{"start":{"line":53,"column":16},"end":{"line":53,"column":42}},"31":{"start":{"line":56,"column":16},"end":{"line":56,"column":45}},"32":{"start":{"line":60,"column":12},"end":{"line":60,"column":41}},"33":{"start":{"line":64,"column":0},"end":{"line":64,"column":46}}},"fnMap":{"0":{"name":"(anonymous_0)","decl":{"start":{"line":3,"column":18},"end":{"line":3,"column":19}},"loc":{"start":{"line":3,"column":30},"end":{"line":3,"column":46}},"line":3},"1":{"name":"(anonymous_1)","decl":{"start":{"line":10,"column":30},"end":{"line":10,"column":31}},"loc":{"start":{"line":10,"column":78},"end":{"line":20,"column":1}},"line":10},"2":{"name":"(anonymous_2)","decl":{"start":{"line":11,"column":31},"end":{"line":11,"column":32}},"loc":{"start":{"line":11,"column":43},"end":{"line":15,"column":5}},"line":11},"3":{"name":"(anonymous_3)","decl":{"start":{"line":12,"column":19},"end":{"line":12,"column":20}},"loc":{"start":{"line":12,"column":31},"end":{"line":14,"column":9}},"line":12},"4":{"name":"(anonymous_4)","decl":{"start":{"line":17,"column":20},"end":{"line":17,"column":21}},"loc":{"start":{"line":17,"column":38},"end":{"line":19,"column":5}},"line":17},"5":{"name":"(anonymous_5)","decl":{"start":{"line":25,"column":33},"end":{"line":25,"column":34}},"loc":{"start":{"line":25,"column":63},"end":{"line":33,"column":1}},"line":25},"6":{"name":"(anonymous_6)","decl":{"start":{"line":30,"column":20},"end":{"line":30,"column":21}},"loc":{"start":{"line":30,"column":38},"end":{"line":32,"column":5}},"line":30},"7":{"name":"(anonymous_7)","decl":{"start":{"line":42,"column":24},"end":{"line":42,"column":25}},"loc":{"start":{"line":42,"column":43},"end":{"line":63,"column":1}},"line":42},"8":{"name":"(anonymous_8)","decl":{"start":{"line":43,"column":20},"end":{"line":43,"column":21}},"loc":{"start":{"line":43,"column":38},"end":{"line":47,"column":5}},"line":43},"9":{"name":"(anonymous_9)","decl":{"start":{"line":44,"column":27},"end":{"line":44,"column":28}},"loc":{"start":{"line":44,"column":39},"end":{"line":46,"column":9}},"line":44},"10":{"name":"(anonymous_10)","decl":{"start":{"line":45,"column":27},"end":{"line":45,"column":28}},"loc":{"start":{"line":45,"column":39},"end":{"line":45,"column":56}},"line":45},"11":{"name":"(anonymous_11)","decl":{"start":{"line":48,"column":11},"end":{"line":48,"column":12}},"loc":{"start":{"line":48,"column":31},"end":{"line":62,"column":5}},"line":48}},"branchMap":{"0":{"loc":{"start":{"line":27,"column":4},"end":{"line":28,"column":15}},"type":"if","locations":[{"start":{"line":27,"column":4},"end":{"line":28,"column":15}},{"start":{"line":27,"column":4},"end":{"line":28,"column":15}}],"line":27},"1":{"loc":{"start":{"line":50,"column":23},"end":{"line":50,"column":87}},"type":"cond-expr","locations":[{"start":{"line":50,"column":71},"end":{"line":50,"column":73}},{"start":{"line":50,"column":76},"end":{"line":50,"column":87}}],"line":50},"2":{"loc":{"start":{"line":50,"column":23},"end":{"line":50,"column":68}},"type":"binary-expr","locations":[{"start":{"line":50,"column":23},"end":{"line":50,"column":51}},{"start":{"line":50,"column":55},"end":{"line":50,"column":68}}],"line":50},"3":{"loc":{"start":{"line":52,"column":12},"end":{"line":57,"column":13}},"type":"if","locations":[{"start":{"line":52,"column":12},"end":{"line":57,"column":13}},{"start":{"line":52,"column":12},"end":{"line":57,"column":13}}],"line":52}},"s":{"0":1,"1":1,"2":1,"3":1,"4":1,"5":1,"6":1,"7":3,"8":3,"9":1,"10":1,"11":3,"12":1,"13":1,"14":3,"15":3,"16":2,"17":1,"18":1,"19":3,"20":1,"21":1,"22":7,"23":21,"24":39,"25":3,"26":7,"27":10,"28":10,"29":10,"30":5,"31":4,"32":1,"33":1},"f":{"0":1,"1":1,"2":3,"3":3,"4":3,"5":3,"6":3,"7":7,"8":21,"9":39,"10":3,"11":10},"b":{"0":[2,1],"1":[9,1],"2":[10,10],"3":[5,4]},"inputSourceMap":{"version":3,"file":"/Users/sba/Documents/finapiRelated/k8s-graceful-shutdown/lib/k8s-graceful-shutdown.ts","sources":["/Users/sba/Documents/finapiRelated/k8s-graceful-shutdown/lib/k8s-graceful-shutdown.ts"],"names":[],"mappings":";;AAmBA,IAAM,WAAW,GAAG,cAAM,OAAA,IAAI,EAAJ,CAAI,CAAA;AAC9B,IAAM,KAAK,GAAG,IAAI,GAAG,EAAsD,CAAA;AAC3E,IAAM,OAAO,GAAG,CAAC,QAAQ,EAAE,SAAS,EAAE,SAAS,CAAU,CAAA;AACzD;;;GAGG;AACH,IAAM,uBAAuB,GAAG,UAAC,gBAAwB,EAAE,kBAA4C;IACrG,IAAM,oBAAoB,GAAG;QAC3B,UAAU,CAAC;YACT,kBAAkB,EAAE,CAAA;QACtB,CAAC,EAAE,gBAAgB,CAAC,CAAA;IACtB,CAAC,CAAA;IAED,KAAK,CAAC,GAAG,CAAC,kBAAkB,EAAE,oBAAoB,CAAC,CAAA;IACnD,OAAO,CAAC,OAAO,CAAC,UAAA,MAAM;QACpB,OAAO,CAAC,EAAE,CAAC,MAAM,EAAE,oBAAoB,CAAC,CAAA;IAC1C,CAAC,CAAC,CAAA;AACJ,CAAC,CAAA;AAyCQ,0DAAuB;AAxChC;;GAEG;AACH,IAAM,0BAA0B,GAAG,UAAC,kBAA4C;IAC9E,IAAM,mBAAmB,GAAG,KAAK,CAAC,GAAG,CAAC,kBAAkB,CAAC,CAAA;IACzD,IAAI,CAAC,mBAAmB;QAAE,OAAM;IAEhC,KAAK,CAAC,MAAM,CAAC,kBAAkB,CAAC,CAAA;IAChC,OAAO,CAAC,OAAO,CAAC,UAAA,MAAM;QACpB,OAAO,CAAC,cAAc,CAAC,MAAM,EAAE,mBAAmB,CAAC,CAAA;IACrD,CAAC,CAAC,CAAA;AACJ,CAAC,CAAA;AA6BiC,gEAA0B;AA5B5D;;;;;;GAMG;AACH,IAAM,iBAAiB,GAAG,UAAC,OAA6B;IACtD,OAAO,CAAC,OAAO,CAAC,UAAA,MAAM;QACpB,OAAO,CAAC,EAAE,CAAC,MAAM,EAAE;YACjB,OAAO,CAAC,IAAI,GAAG,cAAM,OAAA,KAAK,EAAL,CAAK,CAAA;QAC5B,CAAC,CAAC,CAAA;IACJ,CAAC,CAAC,CAAA;IAEF,OAAO,UAAC,GAAoB,EAAE,GAAmB;;QAC/C,OAAO,CAAC,IAAI,SAAG,OAAO,CAAC,IAAI,mCAAI,WAAW,CAAA;QAC1C,IAAI;YACF,IAAI,OAAO,CAAC,IAAI,CAAC,GAAG,EAAE,GAAG,CAAC,EAAE;gBAC1B,OAAO,CAAC,OAAO,CAAC,GAAG,EAAE,GAAG,CAAC,CAAA;aAC1B;iBAAM;gBACL,OAAO,CAAC,UAAU,CAAC,GAAG,EAAE,GAAG,CAAC,CAAA;aAC7B;SACF;QAAC,OAAO,CAAC,EAAE;YACV,OAAO,CAAC,UAAU,CAAC,GAAG,EAAE,GAAG,CAAC,CAAA;SAC7B;IACH,CAAC,CAAA;AACH,CAAC,CAAA;AAE6D,8CAAiB","sourcesContent":["import { IncomingMessage, ServerResponse } from 'http'\n\ninterface HealthHandlerOptions {\n  /**\n   * Health test callback\n   * Returns true if test passed\n   * Retuns false if test failed\n   */\n  test?: (req: IncomingMessage, res: ServerResponse) => boolean\n  /**\n   * Callback to be triggered if healthy\n   */\n  healthy: (req: IncomingMessage, res: ServerResponse) => void\n  /**\n   * Callback to be triggered if not heathy\n   */\n  notHealthy: (req: IncomingMessage, res: ServerResponse) => void\n}\n\nconst defaultTest = () => true\nconst hooks = new Map<(...args: any[]) => void, (...args: any[]) => void>()\nconst signals = ['SIGINT', 'SIGTERM', 'SIGUSR2'] as const\n/**\n *  When a 'SIGINT', 'SIGTERM' or 'SIGUSR2' exit signal is received,\n *  the provided shutdown callback will be called after the graceful period (ms)\n */\nconst addGracefulShutdownHook = (gracefulPeriodMs: number, gracefulShutdownCB: (...args: any[]) => void) => {\n  const gracefulShutdownHook = () => {\n    setTimeout(() => {\n      gracefulShutdownCB()\n    }, gracefulPeriodMs)\n  }\n\n  hooks.set(gracefulShutdownCB, gracefulShutdownHook)\n  signals.forEach(signal => {\n    process.on(signal, gracefulShutdownHook)\n  })\n}\n/**\n *  Unhooks the provided graceful shutdown hook\n */\nconst removeGracefulShutdownHook = (gracefulShutdownCB: (...args: any[]) => void) => {\n  const gracefuShutdownHook = hooks.get(gracefulShutdownCB)\n  if (!gracefuShutdownHook) return\n\n  hooks.delete(gracefulShutdownCB)\n  signals.forEach(signal => {\n    process.removeListener(signal, gracefuShutdownHook)\n  })\n}\n/**\n * returns a health check function which:\n * 1) Calls the \"healthy\" callback if both the provided \"test\"\n * callback resolves to true, and no exit signals were received.\n * 2) Calls the \"notHealthy\" call back if either the provided \"test\"\n * callback resolves to false, or an exit signal was received.\n */\nconst getHealthzHandler = (options: HealthHandlerOptions) => {\n  signals.forEach(signal => {\n    process.on(signal, () => {\n      options.test = () => false\n    })\n  })\n\n  return (req: IncomingMessage, res: ServerResponse) => {\n    options.test = options.test ?? defaultTest\n    try {\n      if (options.test(req, res)) {\n        options.healthy(req, res)\n      } else {\n        options.notHealthy(req, res)\n      }\n    } catch (e) {\n      options.notHealthy(req, res)\n    }\n  }\n}\n\nexport { addGracefulShutdownHook, removeGracefulShutdownHook, getHealthzHandler }\n"]},"_coverageSchema":"1a1c01bbd47fc00a2c39e90264f33305004495a9","hash":"95ab711f9530215fb806db4c74f5c828f77a8c9f","contentHash":"d9994cd4dc17457cf1894bdacc0a5897c4b4428fb293feb6b53f61dc6026c210"}}